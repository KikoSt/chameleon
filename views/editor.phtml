<div id="awesomeEditor" class="row" style="margin-top: 70px; padding-left: 10px; padding-right: 10px;">
    <form enctype="multipart/form-data" id="editor" method="POST" class="form-horizontal">
    <div class="col-md-4">
        <div class="panel-group" id="accordion">
                <?php
                    foreach($this->elements as $element):
                        $type = get_class($element);
                            include($type . '.inc.php');
                    endforeach;
                ?>
            <input id="templateId" type="hidden" name="templateId" value="<?php echo $this->templateId; ?>">
            <input id="advertiserId" type="hidden" name="advertiserId" value="<?php echo $this->advertiserId; ?>">
            <input id="companyId" type="hidden" name="companyId" value="<?php echo $this->companyId; ?>">
        </div>
    </div>
    </form>
    <div class="col-md-8">
        <div style="position: fixed; margin-left: 50px;">
            <div id="previewImage" class="row" style="margin-left: 5px;">
                <img src="<?php echo $this->gif;?>" alt="">
            </div>
            <div class="row" style="padding-top: 5px; margin-left: 5px;">
                <!--        On click render template and show the change-->
                <button id="preview" type="submit" class="btn btn-info" form="editor" data-loading-text="Loading...">Preview</button>
                <!--        On click render template, show the change and save data to database-->
                <button id="save" type="submit" class="btn btn-danger" form="editor">Save</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        var btn;
        var somethingChanged = false;
        var xcoord = '<?php echo $element->getId();?>#x';

        $('.btn').on('click', function(){
            btn = $(this).attr('id');
        });

        $('#previewalert').hide();

        $(window).keydown(function(e){
            if(e.keyCode == 13) {
                e.preventDefault();
                return false;
            }
        });

        $('.checkbox #shadowCheckBox').change(function() {
            var id = $(this).attr('value');

            if($(this).is(":checked"))
            {
                $(this).attr("checked", true);
                $("#" + id + "_shadowColor").attr('disabled', false).addClass('picker');
                $("#" + id + "_shadowDist").attr('disabled', false);
            }
            else
            {
                $(this).attr("checked", false);
                $("#" + id + "_shadowColor").attr('disabled', true).removeClass('picker').val('');
                $("#" + id + "_shadowDist").attr('disabled', true).val('');
            }
        });

        $('.checkbox #strokeCheckBox').change(function() {
            var id = $(this).attr('value');

            if($(this).is(":checked"))
            {
                $(this).attr("checked", true);
                $("#" + id + "_strokeColor").attr('disabled', false).addClass('picker');
                $("#" + id + "_strokeWidth").attr('disabled', false);
            }
            else
            {
                $(this).attr("checked", false);
                $("#" + id + "_strokeColor").attr('disabled', true).removeClass('picker').val('');
                $("#" + id + "_strokeWidth").attr('disabled', true).val('');
            }
        });

        $('.kv-fileinput-upload').on('click', function(e){
            e.preventDefault();

            var imgsrc = '<?php echo $this->gif;?>';
            var nodeList = $(document).find($('[type="file"]'));
            var formData = new FormData();
            var data = {};

            formData.append('templateId', $('#templateId').attr('value'));
            formData.append('advertiserId', $('#advertiserId').attr('value'));
            formData.append('companyId', $('#companyId').attr('value'));
            formData.append('action', 'nothing');


            for (var i = 0; i < nodeList.length; i++)
            {
                var myId = nodeList[i].getAttribute('id');
                var targetId = myId.replace('_input', '');
                var fileSelect = $("#" + myId);

                var files = fileSelect.prop("files");

                if(files.length > 0)
                {
                    var file = files[0];
                    console.log(targetId);
                    formData.append(targetId, file);
                }
            }

            var xhr =  new XMLHttpRequest();
            xhr.upload.addEventListener('load', onloadHandler, false);
            xhr.open('POST', '/chameleon/ajax/changeSvg.php', true);
            xhr.send(formData);
            return false;

            function onloadHandler() {
                console.log('load');
                // $('#previewalert').show();
                console.log(imgsrc);
                $("#previewImage img").attr('src', imgsrc); // + new Date().getTime())
                // $("#previewImage img").load(function() {
                //     $(this).hide();
                //     $(this).fadeIn('slow');
                // });
            }

            function onloadstartHandler() {
                console.log('loadstart');
            }

            function onprogressHandler() {
                console.log('progress');
            }
            // var xhr = $.ajax({
            //     url: '/chameleon/ajax/changeSvg.php',
            //     data: formData,
            //     processData: false,
            //     contentType: false,
            //     type: 'POST'
            // })
            // .done(function(data, textStatus, jqXHR) {
            //         $('#previewalert').show();
            //         console.log(imgsrc);
            //         $("#previewImage img").attr('src', imgsrc + '?' + new Date().getTime())
            //         $("#previewImage img").load(function() {
            //             $(this).hide();
            //             $(this).fadeIn('slow');
            //         });
            // })
            // .fail(function (xhr, ajaxOptions, thrownError) {
            //         alert(xhr.status);
            //         alert(thrownError);
            // });
        });

        $('#editor').on('submit', function(e){
            console.log(2);
            e.preventDefault();

            $.ajax({
                url: '/chameleon/ajax/changeSvg.php',
                data: $('#editor').serialize() + "&action=" + btn,
                type: 'POST',
                success: function(data, textStatus, jqXHR){
                    $('#previewalert').show();
//                  location.reload();
                    $("#previewImage img").load(function() {
                        // .attr('src', imgsrc + '?' + new Date().getTime())
                        console.log(this);
                        $(this).hide();
                        $(this).fadeIn('slow');
                    });
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status);
                    alert(thrownError);
                }
            })
        });

        $('.picker').colorpicker();

        $("#fileUpload").fileinput();

        $('#awesomeEditor input').change(function() {
            somethingChanged = true;
        });

        $('#overview').click(function() {
            if(somethingChanged == true) {
                if(confirm('Unsaved changes detected ! Continue ?')){
                    window.location.href = "index.php?page=overview";
                }
            }
            else
            {
                window.location.href = "index.php?page=overview";
            }
        });

        $('#awesomeEditor #editor').bootstrapValidator({
            testtext: {
                validators: {
                    notEmpty: {
                        message: 'The price is required'
                    },
                    numeric: {
                        message: 'The price must be a number'
                    }
                }
            }

        });
    });
</script>

